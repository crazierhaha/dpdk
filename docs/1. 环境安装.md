# 1. DPDK环境安装

## 1. 环境安装(vmware+ubuntu20.04)

1. 安装ubuntu虚拟机 vmware

2. 安装net-tools apt install net-tools

3. 虚拟机设置双网卡，一个用于ssh，一个用于dpdk(**多队列网卡**)

   通过 ip link show 查看网卡信息

   桥接网卡作为 DPDK 运行的网卡;NAT 网卡作为 ssh 连接的网卡

4. 修改网卡名 ip link set 原网卡名 name eth0

   如果提示busy，先将网卡停用：ip link set 网卡名 down

   然后修改网卡名

   最后启用网卡

   > 持久化修改网卡名：
   >
   > vi /etc/default/grub 修改成如下：
   > GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"  # 需要修改
   >
   > 执行：update-grub
   >
   > reboot

5. 修改网卡的ip相关信息

   vim /etc/netplan/00-installer-config.yaml   修改网卡名，打开dhcp即可。

   启用修改的内容：netplan apply

6. 修改虚拟网卡名，使虚拟网卡支持多队列

   将 ethernet0.virtualDev 由 e1000 修改 vmxnet3，因为 vmware 的 vmxnet3 支持多队 列网卡。

   ![image-20240110023002712](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240110023002712.png)

7. 查看系统是否支持多队列网卡

   cat /proc/interrupts

   ![image-20240109232257636](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240109232257636.png)

8. 修改ubuntu系统的启动参数，主要修改大页配置

```
# 物理机:
default_hugepages=1G hugepagesz=1G hugepages=20 isolcpus=0-7
虚拟机：
# default_hugepages=1G hugepagesz=2M hugepages=1024 isolcpus=0-2
```

> 查看系统页面大小：getconf PAGESIZE

修改ubuntu系统启动参数，如下：

sudo vim /etc/default/grub

![image-20240110023220682](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240110023220682.png)

在 GRUB_CMDLINE_LINUX参数，添加 net.ifnames=0 biosdevname=0,使得网卡名称从0开始命名。

启用配置：sudo update-grub

## 2. 编译环境

1. 下载版本号为：http://dpdk.org dpdk-19.08.2
2. 安装 make：apt install make
3. 安装 automake：apt install automake
4. 安装gcc：apt install gcc
5. 安装libtool: apt install libtool
6. 安装numa: apt install libnuma-dev
7. 安装pkg-config

## 3. 编译dpdk

设置dpdk的环境变量：

```
# export RTE_SDK=/home/dpdk
# export RTE_TARGET=x86_64-native-linux-gcc
```

执行 testpmd:

./usertools/dpdk-setup.sh

![image-20240110023626509](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240110023626509.png)

64位系统选择39。

选择 43 插入 IGB_UIO 模块， 选择网卡为 vmxnet3 会加载此模块 

选择 44 插入 VFIO 模块，选择网卡为 e1000 会加载此模块 

选择 49 绑定 igb_uio 模块， 也可以退出，通过命令来执行。

```
# ifconfig eth0 down 
# /usertools/dpdk-devbind.py --bind=igb_uio eth0 选择 53 运行 testpmd
```

选择 53 运行 testpmd

![image-20240110042256116](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240110042256116.png)

\> show port info 0

![image-20240110042322359](C:\Users\crazi\AppData\Roaming\Typora\typora-user-images\image-20240110042322359.png)

> ##### dpdk编译时执行53 testpmd测试时，如果执行不成功（testpmd: No probed ethernet devices），是因为执行49网卡绑定不成功导致的。可以使用上述命令执行绑定。

### 编译报错

由于 Ubuntu22.04 内核版本和gcc版本比较高，在编译dpdk时会报错。

解决方式：安装gcc-7

1. 添加镜像

   ```
   (base) root@FIB:~ sudo vim /etc/apt/sources.list
   # 在第一行添加：
   deb [arch=amd64] http://archive.ubuntu.com/ubuntu focal main universe
   ```

2. 更新镜像

   ```
   (base) root@FIB:~ sudo apt-get update
   ```

3. 指定版本安装

   ```
   (base) root@FIB:~ sudo apt-get -y install gcc-7 g++-7
   (base) root@FIB:~ gcc-7 --version
   (base) root@FIB:~ g++-7 --version
   (base) root@FIB:~ gcc --version
   (base) root@FIB:~ g++ --version
   ```

4. 配置gcc/g++版本的优先级

   ```
   update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 50
   update-alternatives  --install /usr/bin/g++ g++ /usr/bin/g++-7 50
   gcc --version
   g++ --version
   # 如果需要修改其它版本：update-alternatives  --install /usr/bin/g++ g++ /usr/bin/g++-10 30
   ```

5. 报 /bin/sh: 2: cc: not found 错误：

   sudo ln -s /usr/bin/gcc /usr/bin/cc

## 4. 编译dpdk程序

Demo：编译 example/helloworld

1. 方法1：make 编译

   进入example/helloworld，直接make

2. 方法2：gcc编译

   ```shell
   gcc -o helloword main.c -I /usr/local/include/dpdk/ -ldpdk -lpthread -lnuma -ldl
   ```

## 5. 其他命令

```
sudo cat /proc/meminfo | grep Huge
```

